---
title: Allergy Counts - An introductory exercise in R 
author: Mark Nielsen
date: '2018-04-16'
slug: allergy-counts
categories:
  - Programming
tags:
  - shiny
  - plotly
  - regex
  - ggplot
---

Springtime. It's definitely that time of year again, when blossoms are popping and the world is coming to life again here in the Rockies.  For some this might be their favorite time of year.  Cool temperatures, budding leaves and the sweet aroma of flowers and blossoming trees... if you can smell them, which in my case is a rare pleasantry. Yes, I have seasonal allergies and let's just say that springtime is not my favorite time of year. In light of my dilemma, I've decided to look at pollen count data to help me keep on top of my antihistamines which in turn keeps those stuffy, sneezy sniffles away.

### Scrape the Data
The first step of my analysis in R will be to pull the allergy count data from the Intermountain Sandy Allergy Clinic facebook page. Before accessing the facebook APIs you'll need to sign up for a developer account and create an app to connect with. [Here](http://thinktostart.com/analyzing-facebook-with-r/) is a blog that can walk you through the steps of setting this up.
```{r setup}
library(Rfacebook)  # Facebook API
library(dplyr)      # Data Wrangling
library(ggplot2)    # Graphing
library(Hmisc)      # Miscellaneous Useful Functions
library(lubridate)  # Date- and Time-stamp functions
library(reshape2)   # Data Wrangling

# Facebook
source('~/projects/allergy-counts/fbauth.R')

Sys.setenv('https_proxy'="")
fb_oauth <- fbOAuth(app_id=.app_id, app_secret=.app_secret)
```

Now, let's search for the Intermountain Sandy Clinic Allergy's page.  I pull all the pages with "intermountain" in the title and then I use subset this to only those that also contain the text "sandy." Next, lets pull the last 1500 posts and take a look at our content.  This may take a few minutes.
```{r facebook}
pages <- searchPages(string="intermountain", token=fb_oauth)
pages[grep("sandy",pages$name,ignore.case = T),]

allergy <- getPage(page="sandyclinicallergy", token = fb_oauth, n=1500)
head(allergy)
```

# Filter posts to only include those that have "pollen count" in the message text
```{r facebook-cont}
counts <- allergy%>%
  select(message,created_time)%>%
  filter(grepl("pollen count",message,ignore.case=T))
```

```{r clean-up}
# Parse the date from the message
datecuts <-regexpr("\\d+\\/\\d+\\/\\d+|\\w+ \\d+, \\d+",counts$message,perl=T)
dates <- ifelse(datecuts==-1,NA,substr(counts$message,datecuts,datecuts + attr(datecuts, "match.length")-1))
dates.new <- ifelse(nchar(dates)==8,as.Date(strptime(dates,"%m/%d/%y")),as.Date(strptime(dates,"%B %d, %Y")))

# Now parse the remainder of the text for pollen counts
pollen <- ifelse(datecuts==-1,counts$message,substr(counts$message,datecuts + attr(datecuts, "match.length"),nchar(counts$message)))
pollen.split <- gsub("\u2026","\\.\\.\\.",pollen)
pollen.split <- gsub(" \\(.*?\\)","",gsub("\n"," ",iconv(pollen.split,"latin1", "ASCII",sub="")))
pollen.split <- gsub("tune\\.\\.\\.","",pollen.split)
pollen.split <- gsub("moderate high","high",pollen.split,ignore.case = T)
pollen.split <- gsub("extra","very",pollen.split,ignore.case = T)

#convert levels to numbers
pollen.split <- gsub("very high","5",pollen.split,ignore.case = T)
pollen.split <- gsub("very low","1",pollen.split,ignore.case = T)
pollen.split <- gsub("extra low","1",pollen.split,ignore.case = T)
pollen.split <- gsub("\\<high\\>","4",pollen.split,ignore.case = T)
pollen.split <- gsub("\\<moderate\\>","3",pollen.split,ignore.case = T)
pollen.split <- gsub("\\<low\\>","2",pollen.split,ignore.case = T)

#remove extra spaces after ellipses and other text
pollen.split <- gsub("mold: ","mold\\.\\.\\.",pollen.split,ignore.case=T)
pollen.split <- gsub("grass: ","grass\\.\\.\\.",pollen.split,ignore.case=T)
pollen.split <- gsub("(\\b)(\\.\\.\\.\\s+)","\\1\\.\\.\\.",pollen.split)
pollen.split <- gsub("(\\b)(\\s+\\.\\.\\.)","\\1\\.\\.\\.",pollen.split)
pollen.split <- gsub("trees","",pollen.split,ignore.case = T)
pollen.split <- gsub("weeds\\.\\.\\.\\d","",pollen.split,ignore.case = T)
pollen.split <- gsub("weeds","",pollen.split,ignore.case = T)
pollen.split <- gsub("lindon","linden",pollen.split,ignore.case = T)
pollen.split <- gsub("grasses","grass",pollen.split,ignore.case = T)
pollen.split <- gsub("chenopods","chenopod",pollen.split,ignore.case = T)
pollen.split <- gsub("\\*chenopod","chenopod",pollen.split,ignore.case = T)
pollen.split <- gsub("\\*sagebrush","sagebrush",pollen.split,ignore.case = T)
pollen.split <- gsub("catttail","cattail",pollen.split,ignore.case = T)
pollen.split <- gsub("maple\\/boxelder","maple",pollen.split,ignore.case = T)
pollen.split <- gsub("elder\\/maple","maple",pollen.split,ignore.case = T)
pollen.split <- gsub("elder","maple",pollen.split,ignore.case = T)
pollen.split <- gsub("cedar\\/juniper","cedar",pollen.split,ignore.case = T)
pollen.split <- gsub("cottonwood\\/aspen","cottonwood",pollen.split,ignore.case = T)
pollen.split <- gsub("aspen\\/cottonwood","cottonwood",pollen.split,ignore.case = T)
pollen.split <- gsub("(maple\\/mulberry)(\\.\\.\\.\\d)","maple\\2 mulberry\\2",pollen.split,ignore.case = T)
pollen.split <- gsub("juniper","cedar",pollen.split,ignore.case = T)
pollen.split <- gsub("ginko","ginkgo",pollen.split,ignore.case = T)
pollen.split <- gsub("gingko","ginkgo",pollen.split,ignore.case = T)
pollen.split <- gsub("sagebrush","sage",pollen.split,ignore.case = T)
pollen.split <- gsub("sage","sagebrush",pollen.split,ignore.case = T)
pollen.split <- gsub("walnt","walnut",pollen.split,ignore.case = T)
pollen.split <- gsub("cattalil","cattail",pollen.split,ignore.case = T)
pollen.split <- gsub("(\\b)(\\.+)(\\d)","\\1\\.\\.\\.\\3",pollen.split,ignore.case = T)
pollen.split <- gsub("\\. ","\\.",pollen.split,ignore.case = T)
pollen.split <- gsub("(\\d)\\.\\.\\.cedar","cedar\\.\\.\\.\\1",pollen.split,ignore.case = T)
pollen.split <- gsub("\\.\\.\\.elm\\.\\.\\.","elm\\.\\.\\.",pollen.split,ignore.case = T)
pollen.split <- gsub("help\\.\\.\\.(\\d)","help \\1",pollen.split,ignore.case = T)



# Clean up levels
pollen.split <- gsub("5!","5",pollen.split,ignore.case = T)
pollen.split <- gsub("4!!!!","4",pollen.split,ignore.case = T)
pollen.split <- gsub("4!","4",pollen.split,ignore.case = T)
pollen.split <- gsub("(\\d)(-|\\()relative","\\1",pollen.split,ignore.case = T)
pollen.split <- gsub("(\\d)(\\(|\\r)","\\1",pollen.split,ignore.case = T)
pollen.split <- gsub("(\\d)\\r","\\1",pollen.split,ignore.case = T)
head(pollen.split)


clean.split <- strsplit(pollen.split,split=" ")
my.reduce <- function(x) x[grepl("\\.\\.\\.",x) & !grepl("none",x,ignore.case=T)]
clean.split2 <- lapply(clean.split,my.reduce)

myclean <- function(x) {
  if(length(x)>0){
    myx<-unlist(strsplit(x,"\\.\\.\\."))
    myx<-myx[myx!=""]
    mymat <- matrix(myx,ncol=2,byrow=T)
    mymat[,2]<- gsub("\\.","",mymat[,2])
    return(mymat)
  }
  else mymat <- NULL
}

final.clean <-lapply(clean.split2,myclean)

#get list of all pollen sources
mynames <- function(x) x[,1]
unique.names <-unique(tolower(unlist(lapply(final.clean,mynames))))
# Check to see if there are any funny names or numbers.
unique.names[order(unique.names)]

mylevels <- function(x) x[,2]
unique.counts <-unique(tolower(unlist(lapply(final.clean,mylevels))))
# Check to see if there are any funny numbers.
unique.counts[order(unique.counts)]

# populate the data now
counts[unique.names] <- 0

for (i in 1:length(final.clean)){
  print(i)
  for (j in unique.names){
    if (!is.null(final.clean[[i]])) {
      myrow <- grepl(j,tolower(final.clean[[i]][,1]))
      if(sum(myrow)>0){
        tmp <- as.numeric(final.clean[[i]][which(myrow),2])
        counts[i,j] = mean(tmp)
      }
    }
  }
}


# See what is still missing
miss <- which(!complete.cases(counts))
pollen[miss]
pollen.split[miss]
final.clean[miss]
counts[miss,]

counts$created_time <- as.Date(substr(counts$created_time,1,10))

```


```{r filter-pollens}
# remove weed since it is too general
counts$weed<-NULL

# Define allergen groups for trees and weeds
trees <- c("alder","ash","beech","birch","cedar","chestnut","cottonwood",
           "elm","ginkgo","linden","maple","mulberry","oak","olive","pecan",
           "pine","privet","sycamore","walnut","willow")
# counts$trees <- rowMeans(counts[,trees], na.rm = TRUE)
counts$trees <- apply(counts[,trees],1,max,na.rm = TRUE)

weeds <- c("cattail","chenopod","dock","ephedra","hemp",
           "nettle","plantain","ragweed","sagebrush","sedge")
# counts$weeds <- rowMeans(counts[,weeds], na.rm = TRUE)
counts$weeds <- apply(counts[,weeds],1,max,na.rm = TRUE)

```



```{r final-data}
# Take a look at our data
head(counts)
describe(counts)

```


```{r}

# Create calendar plot
final <- melt(counts[,-1],id="created_time")

# get day of week and week of year
final$day <- ordered(weekdays(final$created_time),
                      levels=rev(c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday")))

final$week <- lubridate::week(final$created_time)
final$year <- year(final$created_time)
head(final)

# Now plot pollen counts over time
all.trees <- final[final$variable %in% trees,]
ggplot(all.trees,aes(week,day,fill=value)) + geom_tile() + 
  facet_grid(variable~year) + 
  scale_fill_gradient(low = "white", high = "blue") 

all.weeds <- final[final$variable %in% weeds,]
ggplot(all.weeds,aes(week,day,fill=value)) + geom_tile()  + 
  facet_grid(variable~year) + 
  scale_fill_gradient(low = "white", high = "blue") 
```


```{r}
summary <- final[final$variable %in% c("grass","mold","trees","weeds"),]

# get week of first day of each month
mnth <- expand.grid(month=1:12,day=1,year=2011:2017)
mnth$dt <- mdy(paste(mnth$month,mnth$day,mnth$year,sep='-'))
mnth$wk <- lubridate::week(mnth$dt)
mnth$mnname <- month(mnth$dt, label = TRUE, abbr = TRUE)
mnlab <- aggregate(wk~mnname,data=mnth,FUN = 'mean')

ggplot(summary,aes(week,day,fill=value)) + geom_tile() +
  facet_grid(year~variable) + 
  scale_y_discrete(labels=c("","F","","W","","M")) +
  scale_x_continuous(breaks=mnlab$wk,labels=mnlab$mnname) +
  scale_fill_gradient(low = "white", high = "blue", breaks=0:5,
                      labels=c("None","Very Low","Low","Moderate","High","Very High")) +
  labs(title="Seasonal Allergies Pollen Trends",
       subtitle="By Pollen Type and Year",
       caption="Source: Intermountain Allergy & Asthma",
       x="", y="", fill = "Pollen Count")
```


```{r shiny}
save(list=ls(),file="allergy-report/data/pollen-final.Rdat")
```
